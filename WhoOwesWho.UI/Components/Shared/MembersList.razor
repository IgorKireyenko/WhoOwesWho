@using WhoOwesWho.Common.Groups.Dto

<div class="members-list-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="section-title mb-0">Members</h3>
        @if (OnAddMember.HasDelegate)
        {
            <button class="btn btn-sm btn-primary" @onclick="OnAddMember">
                <i class="bi bi-plus-circle me-1"></i> Add member
            </button>
        }
    </div>
    @if (Members is null || Members.Count == 0)
    {
        <div class="alert alert-info" role="alert">
            <p class="mb-0">No members in this group yet.</p>
        </div>
    }
    else
    {
        <div class="members-list">
            @foreach (var member in Members)
            {
                <div class="member-item">
                    <div class="member-avatar">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <span class="member-name">@member.Name</span>
                    @if (OnRemoveMember.HasDelegate && !IsAuthenticatedUser(member.Name))
                    {
                        <button class="btn btn-sm btn-outline-danger ms-auto" @onclick="() => ShowRemoveConfirmation(member)">
                            <i class="bi bi-trash"></i> Remove
                        </button>
                    }
                </div>
            }
        </div>
    }
</div>

<ConfirmationModal @ref="confirmationModal" 
                   Title="Remove Member" 
                   Message="Are you really sure you want to remove this item?" 
                   OnConfirm="HandleRemoveMemberAsync" />

@code {
    private const string AuthenticatedUserMemberName = "You";

    [Parameter, EditorRequired]
    public required List<MemberDto> Members { get; set; }

    [Parameter]
    public EventCallback OnAddMember { get; set; }

    [Parameter]
    public EventCallback<Guid> OnRemoveMember { get; set; }

    private ConfirmationModal? confirmationModal;
    private Guid memberToRemove;

    private bool IsAuthenticatedUser(string memberName) => 
        memberName.Equals(AuthenticatedUserMemberName, StringComparison.OrdinalIgnoreCase);

    private void ShowRemoveConfirmation(MemberDto member)
    {
        memberToRemove = member.Id;
        confirmationModal?.Show();
    }

    private async Task HandleRemoveMemberAsync()
    {
        if (OnRemoveMember.HasDelegate)
        {
            await OnRemoveMember.InvokeAsync(memberToRemove);
        }
    }
}
